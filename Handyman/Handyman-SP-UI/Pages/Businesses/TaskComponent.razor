@page "/task-c"
@page "/task"

@using Microsoft.AspNetCore.Components.Web
@implements IDisposable
@inject IRequestHelper _requestHelper              

<style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        height: 3rem;
        background-color: rgba(0, 0, 0, .1);
        border: solid rgba(0, 0, 0, .15);
        border-width: 1px 0;
        box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
    </style>


@if (taskModel != null)
{
    <!--Task Header-->
    <div class="container py-4">

       
       @* <header class="pb-3 mb-4 border-bottom">
            <a href="/" class="d-flex align-items-center text-dark text-decoration-none">             
                
            </a>
        </header>*@
              <!--Task Details-->
        <div class="p-3 mb-4 bg-light rounded-3">
            <div class="container-fluid">
                <h1 class="display-5 fw-bold"> @taskModel.tas_title </h1>
                
                <p class="fs-4"><strong>Time Started:</strong> @taskModel.tas_date_started</p>
                <p class="col-md-8 fs-4"><strong>Description:</strong> @taskModel.tas_description</p>
                <hr />
                @if (!isWorkingOnTask)
                {


                    @if (taskModel.tas_status == 0)
                    {
                        <button @onclick="StartTask" class="btn btn-primary btn-lg alert-info" type="button">Start Task</button>
                    }
                    @if (taskModel.tas_status == 1)
                    {
                        <button @onclick="WorkOnTask"  class="btn btn-primary btn-lg alert-secondary" type="button">Work on it</button>
                    }
                    @if (taskModel.tas_status == 2)
                    {
                        <button @onclick="FinishTask" class="btn btn-primary btn-lg alert-success" type="button">Finish it</button>
                    }
                }else
                {
                    <div class="card text-dark">
                        <img src="./images/handymangif.gif" class="card-img" height="400" alt="...">
                        <div class="card-img-overlay text-center">
                            <p class="card-text">You have been working on this task for: <small class="text-muted"> @taskModel.tas_duration days</small></p>
                            <button @onclick="PauseTask" class="btn btn-outline-secondary btn-md" type="button">Update</button>
                        </div>
                    </div>
                }

            </div>
        </div>

        <!--Task duration-->
        @if (!isWorkingOnTask)
        {
        <div class="row align-items-md-stretch justify-content-center">
            <div class="col-md-6 align-content-center">
                <div class="p-3 text-bg-dark rounded-3">
                    <h2>Duration</h2>
                   


                        @if (taskModel.tas_status == 0)
                        {
                            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" style="width: 0%">0%</div>  <!--This will be implemented by duration of the task-->
                            </div>
                        }
                        @if (taskModel.tas_status == 1)
                        {
                            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" style="width: 25%">25%</div>  <!--This will be implemented by duration of the task-->
                            </div>
                        }
                        @if (taskModel.tas_status == 2)
                        {
                            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" style="width: 50%">50%</div>  <!--This will be implemented by duration of the task-->
                            </div>
                        }
                        @if (taskModel.tas_status == 3)
                        {
                            <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar" style="width: 100%">100%</div>  <!--This will be implemented by duration of the task-->
                            </div>
                        }

                     

                </div>
               
            </div>
           
        </div>
        }
    </div>
}else
{
    <!--Task placeholder-->
    <div class="col-md-6">
        <div class="card" aria-hidden="true">
            <img src="..." class="card-img-top" alt="...">
            <div class="card-body">
                <h5 class="card-title placeholder-glow">
                    <span class="placeholder col-6"></span>
                </h5>

                <p class="card-text placeholder-glow">
                    <span class="placeholder col-7"></span>
                    <span class="placeholder col-4"></span>
                    <span class="placeholder col-4"></span>
                    <span class="placeholder col-6"></span>
                    <span class="placeholder col-8"></span>
                </p>
                <a href="#" tabindex="-1" class="btn btn-primary disabled placeholder col-6"></a>
            </div>
        </div>
    </div>
}

@code {


    int TaskId;
    TaskModel? taskModel;

    //Timer taskTtimer;

    [Parameter]
    [SupplyParameterFromQuery]
    public int Id { get { return TaskId; } set { TaskId = value; } }

    [Parameter]
    public EventCallback<TaskModel> OnTaskUpdate { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            taskModel = await _requestHelper.GetTask(TaskId);
            DeliverTask();
        }catch(Exception ex)
        {
            throw new Exception(ex.Message, ex.InnerException);
        }
    }

    void DeliverTask()
    {
        if(taskModel.tas_status < 3)
        {
            //the task is not yet complete       
            taskModel.tas_duration = (DateTime.UtcNow - taskModel.tas_date_started).Days;

        }
    }

    //**********************Updating the task methods******************************//

    /// <summary>
    /// Start working a task
    /// </summary>
    void StartTask()
    {
        if (taskModel != null && taskModel.tas_status < 1)
        {
            taskModel.tas_status = 1;
            isWorkingOnTask = true;
            //Update DB
        }
    }

    /// <summary>
    /// Continue working with a started task
    /// </summary>
    bool isWorkingOnTask;
    void WorkOnTask()
    {
        if (taskModel != null && (taskModel.tas_status == 1))
        {
            taskModel.tas_status = 2;
            isWorkingOnTask = true;
            //Update DB
        }
    } 

    /// <summary>
    /// Finish the task
    /// </summary>
    void FinishTask()
    {
        if (taskModel != null && (taskModel.tas_status == 2))
        {
            taskModel.tas_status = 3;
            isWorkingOnTask = false;
            //Update DB
        }

    }

    //**********************End Updating the task methods******************************//

    /// <summary>
    /// Pause the task / temporarily stop working on the task
    /// </summary>
    void PauseTask()
    {
        isWorkingOnTask = false;
    }

    public void Dispose()
    {
       // taskTtimer.Dispose();
    }
}
