@page "/register-work-shop"
@page "/registers"

@using Microsoft.AspNetCore.Identity
@using Handyman_SP_UI.Areas.Identity.Data

@using HandymanProviderLibrary.Api.Service
@using HandymanProviderLibrary.Models
@using Handyman_SP_UI.Pages.ServiceProviderComponent
@using Microsoft.AspNetCore.Components.Web

@inject IServiceEndpoint _servicesEP
@inject IBusinessHelper _businessHLP
@inject SignInManager<Handyman_SP_UIUser> SignInManager
@inject UserManager<Handyman_SP_UIUser> UserManager
@inject NavigationManager NavManager

<AuthorizeView Context="Auth" Roles="ServiceProvider">
    <Authorized>
        <!--Register WorkShop Full Screen Modal-->
        <!-- Full screen modal -->
      
        <!--In Between Modals-->
        <div class="modal" id="regWorkShopModalToggle" aria-hidden="true" aria-labelledby="regWorkShopModalToggleLabel" tabindex="-1">
            <div class="modal-dialog modal-fullscreen-xxl-down">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5 font-monospace" id="regWorkShopModalToggleLabel">Register A Work-Shop</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                 
                <div class="container container-fluid">

                   
                        <div class="form-control" id="buisnessRegistrationForm">
                                
                            
                                <div class="form-control">
                                    <label for="businessName" class="form-label">Business name</label>
                                    <input type="text" class="form-control" @bind-value="@newBusiness.Name" id="businessName" placeholder="Work shop name..." required>

                                </div>

                                <div class="form-control">
                                    <label for="busDescription" class="form-label">Business Description</label>
                                      <input type="text" class="form-control" @bind-value="@newBusiness.Description" id="busDescription" placeholder="What do you do?" required>
                                </div>
                                <br />
                                <!--Registration-->

                                <div class="form-control">
                                    <label for="@newBusiness.registration.regNumber" class="form-label">Registration Number</label>
                                    <p>
                                        <input type="text" class="form-control" @bind-value="@newBusiness.registration.regNumber" id="v@newBusiness.registration.regNumber" placeholder="#555-2245" required />
                                    </p>
                                </div>

                                <div class="form-control">
                                    <label for="taxNumber" class="form-label">Tax Number</label>

                                    <input type="number" class="form-control" @bind-value="@newBusiness.registration.taxNumber" id="taxNumber" placeholder="#37445784" required>

                                </div>

                                <div class="form-control">
                                    <label for="workplaceType" class="form-label">Type</label>
                                        <select type="text" class="form-select" @onchange="SelectedBusinessType" id="workplaceType">
                                        <option selected>Choose...</option>
                                        <option value="1">Remote</option>
                                        <option value="2">In person</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a Business Type.
                                    </div>
                                </div>
                                <!--End Registration-->
                                <!--End Business-->

                        </div>
                        <hr />
                                        <!--Address-->
                        <div class="mb-3 form-control" id="businessAddressForm">

                                
                            <div class="form-control">
                                <label for="streetAddress" class="form-label">Street Address</label>
                                <input type="text" @bind-value="newBusiness.address.add_street" class="form-control" id="streetAddress" placeholder="4 First Ave" required>
                                <div class="invalid-feedback">
                                    Please provide a valid street address.
                                </div>
                            </div>
                            <div class="form-control">
                                <label for="suburb" class="form-label">Suburb</label>
                                <input type="text" @bind-value="newBusiness.address.add_suburb" class="form-control" id="suburb" placeholder="Emadadeni" required>
                                <div class="invalid-feedback">
                                    Please provide a valid suburb.
                                </div>
                            </div>
                            <div class="form-control">
                                <label for="city" class="form-label">City</label>
                                <input type="text" @bind-value="newBusiness.address.add_city" class="form-control" id="city" placeholder="City Zee" required>
                                <div class="invalid-feedback">
                                    Please provide a valid city.
                                </div>
                            </div>

                            <div class="mb-3 form-control">
                                <label for="state" class="form-label">State</label>
                                <select type="text" @onchange="SelectedState" class="form-select" id="state">
                                    <option selected>Choose...</option>
                                    <option value="GP">Gauteng Province</option>
                                    <option value="EC">Eastern Cape</option>
                                    <option value="MP">Mpumalanga</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select a valid state.
                                </div>
                                    <div class="col">
                                        <label for="zipCode" class="form-label">Zip Code</label>
                                        <input type="number" @bind-value="newBusiness.address.add_zip" class="form-control" id="zipCode" placeholder="2000" required>
                                        <div class="invalid-feedback">
                                            Please provide a valid zip.
                                        </div>
                                    </div>
                            

                            </div>
                            <!---End address-->
                        </div>
                        @if (!IsWorkShopSaved)
                        {
                            <button class="btn btn-dark btn-outline-success" @onclick="SaveWorkShopDetails">
                                Save
                            </button>
                        }
               
                </div>
              </div>
                @if (IsWorkShopSaved)
                {
                    <div class="modal-footer">
                        <button class="btn btn-primary" data-bs-target="#regProviderModalToggle" data-bs-toggle="modal">
                            Next
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right-short" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                                </svg>
                        </button>
                    </div>
                }
                    
            </div>
          </div>
        </div>
         <!--End Register WorkShop Full Screen Modal-->

        <!--Profile registration-->
        <div class="modal" id="regProviderModalToggle" aria-hidden="true" aria-labelledby="regProviderModalToggleLabel2" tabindex="-">
            <div class="modal-dialog modal-fullscreen-xxl-down">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="regProviderModalToggleLabel2">Add Members</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                   <AddMembers OnSaveMembers="SaveMembers" NewBusiness="newBusiness">

                   </AddMembers>
              </div>
                @if(IsMemberAdded)
                {
                    <div class="modal-footer">
                        <button class="btn btn-primary" data-bs-target="#regServiceToggle" data-bs-toggle="modal">
                            Next
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right-short" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z" />
                            </svg>
                        </button>
                    </div>
                }
                   
            </div>
          </div>
        </div>


        <!--Service registration-->
        <div class="modal" id="regServiceToggle" aria-hidden="true" aria-labelledby="regServiceToggleLabel" tabindex="-">
            <div class="modal-dialog modal-fullscreen-xxl-down">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="regServiceToggleLabel">Add Members</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        
                    </div>
                    @if (IsServiceAdded)
                    {
                        <div class="modal-footer">
                            <button class="btn btn-primary" @onclick="SubmitWorkShopReg" data-bs-target="#regWorkShopModalToggle" data-bs-toggle="modal">
                                Finish
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-square" viewBox="0 0 16 16">
                                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                    <path d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.235.235 0 0 1 .02-.022z" />
                                </svg>    
                            </button>
                        </div>
                    }
                   
                </div>
            </div>
        </div>

        <!--End Service registratiokn-->


        <!--Single Member Registration-->
        <div class="modal" id="regSingMemberToggle" aria-hidden="true" aria-labelledby="regSingMemberToggleLabel" tabindex="-">
            <div class="modal-dialog modal-fullscreen-xxl-down">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="regSingMemberToggleLabel">Register Profile</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      
                    </div>
                </div>
            </div>
        </div>

        <!--End Single User Registration-->
        <button class="btn btn-primary" data-bs-target="#regWorkShopModalToggle" data-bs-toggle="modal">Open a Work Shop</button>

        <button class="btn btn-primary" data-bs-target="#regSingMemberToggle" data-bs-toggle="modal">Join Work-Shop</button>

        <!--End Full screen modal -->      
        <!--End In Between Modal-->
            </Authorized>
</AuthorizeView>
@code {
    private BusinessModel? newBusiness = new();
    private string? ErrorMsg;

    private IList<ServiceModel>? services;
    private bool IsWorkShopSaved;
    private bool IsMemberAdded;
    private bool IsServiceAdded;


    protected override async Task OnInitializedAsync()
    {

        IsWorkShopSaved = false;
    }

    void SelectedBusinessType(ChangeEventArgs e)
    {
        if (e.Value is not null)
        {
            if (e.Value.ToString() == "1")
            {
                //Remote
                newBusiness.Type = 1;
            }
            else if (e.Value.ToString() == "2")
            {
                //In person
                newBusiness.Type = 2;
            }

        }
    }

    void SelectedState(ChangeEventArgs e)
    {
        if (e.Value is not null)
        {
            newBusiness.address.add_state = (string)e.Value;
        }
    }

    void SaveMembers(BusinessModel newWorkShopWithMembers)
    {
        if (newWorkShopWithMembers!=null && newWorkShopWithMembers.Employees.Count>0)
        {
            newBusiness = newWorkShopWithMembers;
            IsMemberAdded = true;
        }

    }


    private void SaveWorkShopServices(BusinessModel brandNewWorkShop)
    {
        if (brandNewWorkShop != null)
        {
            newBusiness = brandNewWorkShop;
            IsServiceAdded = true;

        }

    }

    void SaveSingleMember(ServiceProviderModel member)
    {
        newBusiness = new();
        if (member != null)
        {
            newBusiness.Employees.Add(member);
        }
    }

    void SaveWorkShopDetails()
    {

        IsWorkShopSaved = true;
    }

    async Task SubmitWorkShopReg()
    {
        try
        {
            _businessHLP.CreateBusiness(newBusiness);
        }
        catch (Exception)
        {
            
            throw;
        }
    }

}
 